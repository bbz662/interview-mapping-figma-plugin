<form id="interviewForm">
  <input type="text" id="apiKey" placeholder="Enter Gemini API Key" required>
  <textarea id="interviewScript" rows="10" cols="50" required></textarea>
  <button type="submit">Analyze</button>
</form>

<div id="loading" style="display: none;">Analyzing...</div>
<div id="error" style="color: red;"></div>
<script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
</script>
<script type="module">
  import { GoogleGenerativeAI } from "@google/generative-ai";
  document.getElementById('interviewForm').addEventListener('submit', async function (event) {
    event.preventDefault();
    const apiKey = document.getElementById('apiKey').value;
    const script = document.getElementById('interviewScript').value;

    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').textContent = '';

    try {
      const result = await analyzeInterviewWithGemini(apiKey, script);
      parent.postMessage({ pluginMessage: { type: 'analysis-complete', result } }, '*');
    } catch (error) {
      document.getElementById('error').textContent = `Error: ${error.message}`;
      parent.postMessage({ pluginMessage: { type: 'analysis-complete', error: error.message } }, '*');
    } finally {
      document.getElementById('loading').style.display = 'none';
    }
  });

  async function analyzeInterviewWithGemini(apiKey, script) {
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({
      model: "gemini-1.5-flash",
      generationConfig: { responseMimeType: "application/json" }
    });

    const prompt = `
    Extract key insights from user interview data using the KA method:

    - For each notable event or observation from the interview:
      a. Event: Describe the situation, action, motivation, and result in 1-2 sentences.
      b. Inner Voice: Imagine and write down what the user might be thinking or feeling in that moment, expressed in a brief quote.
      c. Value: Identify the underlying value or need driving the user's behavior or thoughts.
    - Create a KA card for each event, including all three elements above.
    - Group similar KA cards together based on common themes or values.
    - Draw connections between groups to create a value structure map:
      - Use arrows to show relationships
      - Add brief explanatory notes on the connections

    Summarize the key user needs and insights revealed by the value structure map.

    Remember to:

    - Focus on the user's perspective when filling out KA cards
    - Avoid inserting your own assumptions, especially for the "Inner Voice" section
    - Keep groupings relatively small to maintain specificity
    - Be prepared to revise card content during the grouping process if needed
    - Analyze the following user interview and extract key components and their connections (select ouput language based on interview language):

    ${script}

    Use the following JSON schema for your response:
    {
      "type": "object",
      "properties": {
        "components": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "name": { "type": "string" },
              "description": { "type": "string" },
              "connections": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "string" },
                    "type": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    }`;

    const result = await model.generateContent(prompt);
    const response = result.response;
    const text = response.text();

    return JSON.parse(text);
  }
</script>